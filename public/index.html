<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zombie TD Reborn</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0d0f12;
      --panel: #1a1d24;
      --accent: #3d8b5c;
      --accent-hover: #4da86d;
      --text: #e8eaed;
      --muted: #9aa0a6;
      --danger: #c52233;
      --input-bg: #252830;
      --border: #2d3139;
    }
    html, body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(61,139,92,0.12) 0%, transparent 50%);
      pointer-events: none;
    }
    .wrap {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 420px;
    }
    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }
    .logo h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.02em;
    }
    .logo p {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.75rem;
      margin-bottom: 1rem;
    }
    .panel h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--muted);
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    .form-group input {
      width: 100%;
      padding: 0.65rem 0.85rem;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .btn {
      display: block;
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.2s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      margin-top: 0.5rem;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary {
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      margin-top: 0.5rem;
    }
    .btn-secondary:hover { background: var(--border); }
    .btn-menu {
      margin-bottom: 0.75rem;
    }
    .btn-menu:last-child { margin-bottom: 0; }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tabs button {
      flex: 1;
      padding: 0.5rem;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      font-size: 0.9rem;
      cursor: pointer;
    }
    .tabs button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .tabs button:hover:not(.active) { color: var(--text); }
    .menu-view .user-info {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }
    .menu-view .user-info strong { color: var(--accent); }
    .menu-view .logout {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 1rem;
      cursor: pointer;
      text-decoration: underline;
    }
    .menu-view .logout:hover { color: var(--text); }
    .msg {
      font-size: 0.9rem;
      padding: 0.5rem 0;
      margin-top: 0.5rem;
    }
    .msg.err { color: var(--danger); }
    .msg.ok { color: var(--accent); }
    #ranking-list {
      list-style: none;
      margin-top: 0.75rem;
    }
    #ranking-list li {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    #ranking-list li:last-child { border-bottom: none; }
    .credits-view {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.6;
    }
    .credits-view h3 { color: var(--text); font-size: 1rem; margin-top: 1rem; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <h1>Zombie TD Reborn</h1>
      <p>Zombie TD: Renascido</p>
    </div>

    <!-- Login / Registro -->
    <div id="auth-view" class="panel">
      <div class="tabs">
        <button type="button" id="tab-login" class="active">Entrar</button>
        <button type="button" id="tab-register">Criar conta</button>
      </div>
      <div id="form-login">
        <h2>Entrar</h2>
        <form id="login-form">
          <div class="form-group">
            <label for="login-user">Usuário ou e-mail</label>
            <input id="login-user" type="text" required autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="login-pass">Senha</label>
            <input id="login-pass" type="password" required autocomplete="current-password" />
          </div>
          <p id="login-msg" class="msg hidden"></p>
          <button type="submit" class="btn btn-primary">Entrar</button>
        </form>
      </div>
      <div id="form-register" class="hidden">
        <h2>Criar conta</h2>
        <form id="register-form">
          <div class="form-group">
            <label for="reg-user">Usuário</label>
            <input id="reg-user" type="text" required minlength="2" maxlength="64" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="reg-email">E-mail (opcional)</label>
            <input id="reg-email" type="email" autocomplete="email" />
          </div>
          <div class="form-group">
            <label for="reg-pass">Senha</label>
            <input id="reg-pass" type="password" required minlength="6" autocomplete="new-password" />
          </div>
          <p id="register-msg" class="msg hidden"></p>
          <button type="submit" class="btn btn-primary">Criar conta</button>
        </form>
      </div>
    </div>

    <!-- Menu (após login) -->
    <div id="menu-view" class="panel menu-view hidden">
      <p class="user-info">Olá, <strong id="menu-username"></strong></p>
      <a href="/game.html" class="btn btn-primary btn-menu">Iniciar partida</a>
      <button type="button" id="btn-ranking" class="btn btn-secondary btn-menu">Ranking</button>
      <button type="button" id="btn-credits" class="btn btn-secondary btn-menu">Créditos</button>
      <p class="logout" id="btn-logout">Sair</p>
    </div>

    <!-- Ranking (modal dentro da mesma página) -->
    <div id="ranking-view" class="panel hidden">
      <h2>Ranking (PDL)</h2>
      <ul id="ranking-list"></ul>
      <button type="button" id="btn-back-ranking" class="btn btn-secondary" style="margin-top:1rem">Voltar</button>
    </div>

    <!-- Créditos -->
    <div id="credits-view" class="panel hidden">
      <h2>Créditos</h2>
      <div class="credits-view">
        <p>Zombie TD Reborn — Zombie TD: Renascido.</p>
        <h3>Jogo</h3>
        <p>Gameplay e lógica originais do jogo em Flash; adaptado com sistema de elos e PDL.</p>
        <h3>Plataforma</h3>
        <p>Menu e conta em HTML/CSS/JS; jogo rodando via Ruffle (emulador Flash).</p>
      </div>
      <button type="button" id="btn-back-credits" class="btn btn-secondary" style="margin-top:1rem">Voltar</button>
    </div>
  </div>

  <script>
    const API = window.location.origin + '/api';
    const TOKEN_KEY = 'zombie_td_token';
    const USER_KEY = 'zombie_td_user';

    function getToken() { return localStorage.getItem(TOKEN_KEY); }
    function setToken(t) { if (t) localStorage.setItem(TOKEN_KEY, t); else localStorage.removeItem(TOKEN_KEY); }
    function getUser() { try { return JSON.parse(localStorage.getItem(USER_KEY) || 'null'); } catch(e) { return null; } }
    function setUser(u) { localStorage.setItem(USER_KEY, u ? JSON.stringify(u) : 'null'); }

    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    const authView = document.getElementById('auth-view');
    const menuView = document.getElementById('menu-view');
    const rankingView = document.getElementById('ranking-view');
    const creditsView = document.getElementById('credits-view');

    function showAuth() {
      show(authView);
      hide(menuView);
      hide(rankingView);
      hide(creditsView);
    }
    function showMenu() {
      hide(authView);
      show(menuView);
      hide(rankingView);
      hide(creditsView);
      document.getElementById('menu-username').textContent = (getUser() || {}).username || '';
    }
    function showRanking() {
      hide(menuView);
      show(rankingView);
      fetch(API + '/ranking?limit=20')
        .then(r => r.json())
        .then(data => {
          const ul = document.getElementById('ranking-list');
          ul.innerHTML = data.length ? data.map((row, i) =>
            `<li><span>#${i+1} ${row.username}</span><span>${row.pdl} PDL</span></li>`
          ).join('') : '<li>Ninguém no ranking ainda.</li>';
        })
        .catch(() => { document.getElementById('ranking-list').innerHTML = '<li>Erro ao carregar.</li>'; });
    }
    function showCredits() {
      hide(menuView);
      show(creditsView);
    }
    function backToMenu() {
      show(menuView);
      hide(rankingView);
      hide(creditsView);
    }

    if (getToken()) {
      showMenu();
    } else {
      showAuth();
    }

    document.getElementById('tab-login').onclick = () => {
      document.getElementById('tab-login').classList.add('active');
      document.getElementById('tab-register').classList.remove('active');
      show(document.getElementById('form-login'));
      hide(document.getElementById('form-register'));
    };
    document.getElementById('tab-register').onclick = () => {
      document.getElementById('tab-register').classList.add('active');
      document.getElementById('tab-login').classList.remove('active');
      show(document.getElementById('form-register'));
      hide(document.getElementById('form-login'));
    };

    document.getElementById('login-form').onsubmit = async (e) => {
      e.preventDefault();
      const msg = document.getElementById('login-msg');
      msg.classList.add('hidden');
      const body = {
        username: document.getElementById('login-user').value.trim(),
        password: document.getElementById('login-pass').value
      };
      if (document.getElementById('login-user').value.includes('@')) body.email = body.username;
      try {
        const r = await fetch(API + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) { msg.textContent = data.error || 'Erro ao entrar'; msg.classList.add('err'); msg.classList.remove('hidden'); return; }
        setToken(data.token);
        setUser(data.user);
        showMenu();
      } catch (err) {
        msg.textContent = 'Erro de conexão.';
        msg.classList.add('err');
        msg.classList.remove('hidden');
      }
    };

    document.getElementById('register-form').onsubmit = async (e) => {
      e.preventDefault();
      const msg = document.getElementById('register-msg');
      msg.classList.add('hidden');
      const body = {
        username: document.getElementById('reg-user').value.trim(),
        password: document.getElementById('reg-pass').value
      };
      const email = document.getElementById('reg-email').value.trim();
      if (email) body.email = email;
      try {
        const r = await fetch(API + '/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) { msg.textContent = data.error || 'Erro ao criar conta'; msg.classList.add('err'); msg.classList.remove('hidden'); return; }
        setToken(data.token);
        setUser(data.user);
        showMenu();
      } catch (err) {
        msg.textContent = 'Erro de conexão.';
        msg.classList.add('err');
        msg.classList.remove('hidden');
      }
    };

    document.getElementById('btn-logout').onclick = () => { setToken(null); setUser(null); showAuth(); };
    document.getElementById('btn-ranking').onclick = showRanking;
    document.getElementById('btn-credits').onclick = showCredits;
    document.getElementById('btn-back-ranking').onclick = backToMenu;
    document.getElementById('btn-back-credits').onclick = backToMenu;
  </script>
</body>
</html>
